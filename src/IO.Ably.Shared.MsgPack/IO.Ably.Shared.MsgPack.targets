<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <PropertyGroup>
    <MsgPackGeneratorProject>$(MSBuildThisFileDirectory)..\..\tools\MsgPackSerializerGenerator\MsgPackSerializerGenerator.csproj</MsgPackGeneratorProject>
    <MsgPackOutputDirectory>$(MSBuildThisFileDirectory)CustomSerialisers\GeneratedSerializers</MsgPackOutputDirectory>
  </PropertyGroup>

  <!-- Generate MsgPack serializers before compilation -->
  <Target Name="GenerateMsgPackSerializers" BeforeTargets="CoreCompile" Condition="'$(DesignTimeBuild)' != 'true' AND '$(BuildingProject)' == 'true'">
    <Message Text="Generating MsgPack serializers..." Importance="high" />
    
    <!-- Build the generator tool first -->
    <MSBuild Projects="$(MsgPackGeneratorProject)" Targets="Build" Properties="Configuration=$(Configuration)" />
    
    <!-- Run the generator tool -->
    <Exec Command="dotnet &quot;$(MSBuildThisFileDirectory)..\..\tools\MsgPackSerializerGenerator\bin\$(Configuration)\net6.0\MsgPackSerializerGenerator.dll&quot; &quot;$(MsgPackOutputDirectory)&quot;"
          WorkingDirectory="$(MSBuildThisFileDirectory)" />
    
    <Message Text="MsgPack serializers generated successfully" Importance="high" />
  </Target>

  <!-- Clean generated files -->
  <Target Name="CleanMsgPackSerializers" BeforeTargets="CoreClean">
    <ItemGroup>
      <GeneratedSerializers Include="$(MsgPackOutputDirectory)\*.cs" />
    </ItemGroup>
    <Delete Files="@(GeneratedSerializers)" />
  </Target>

  <!-- Include generated files in compilation -->
  <ItemGroup>
    <Compile Include="$(MsgPackOutputDirectory)\*.cs" />
  </ItemGroup>

</Project>
